<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Dispatch System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
                 .grid-container {
             display: inline-block;
             border: 3px solid #2c3e50;
             border-radius: 8px;
             background-color: #ecf0f1;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
             padding: 10px;
             margin: 20px 0;
         }
         .grid {
             display: grid;
             grid-template-columns: repeat(100, 5px);
             grid-template-rows: repeat(100, 5px);
             gap: 1px;
             background-color: #bdc3c7;
             border-radius: 4px;
             padding: 8px;
         }
         .cell {
             width: 5px;
             height: 5px;
             background-color: #ecf0f1;
             border-radius: 1px;
             position: relative;
             transition: all 0.2s ease;
         }
                 .driver {
             background-color: #27ae60;
             border-radius: 50%;
             box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
             border: 1px solid #229954;
         }
         .rider {
             background-color: #3498db;
             border-radius: 50%;
             box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
             border: 1px solid #2980b9;
         }
         .pickup {
             background-color: #e67e22;
             border-radius: 3px;
             box-shadow: 0 2px 4px rgba(230, 126, 34, 0.3);
             border: 1px solid #d35400;
         }
         .dropoff {
             background-color: #9b59b6;
             border-radius: 3px;
             box-shadow: 0 2px 4px rgba(155, 89, 182, 0.3);
             border: 1px solid #8e44ad;
         }
         .pending {
             background-color: #f39c12;
             border-radius: 3px;
             box-shadow: 0 2px 4px rgba(243, 156, 18, 0.3);
             border: 1px solid #e67e22;
             animation: pulse 2s infinite;
         }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .control-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        input {
            padding: 5px;
            margin: 0 10px;
            width: 60px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ride-list {
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ride-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .legend {
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .legend-item {
            display: inline-block;
            margin: 0 20px;
        }
                 .legend-color {
             display: inline-block;
             width: 20px;
             height: 20px;
             margin-right: 5px;
             border-radius: 50%;
         }
         .log-section {
             margin: 20px 0;
             padding: 15px;
             background-color: white;
             border-radius: 5px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
         }
         .log-container {
             max-height: 300px;
             overflow-y: auto;
             border: 1px solid #ddd;
             border-radius: 3px;
             padding: 10px;
             background-color: #f9f9f9;
             font-family: 'Courier New', monospace;
             font-size: 12px;
         }
         .log-entry {
             margin: 5px 0;
             padding: 5px;
             border-radius: 3px;
             border-left: 3px solid #ccc;
         }
         .log-entry.accepted {
             background-color: #d4edda;
             border-left-color: #28a745;
             color: #155724;
         }
         .log-entry.rejected {
             background-color: #f8d7da;
             border-left-color: #dc3545;
             color: #721c24;
         }
         .log-entry.info {
             background-color: #d1ecf1;
             border-left-color: #17a2b8;
             color: #0c5460;
         }
         .log-entry.warning {
             background-color: #fff3cd;
             border-left-color: #ffc107;
             color: #856404;
         }
         .log-timestamp {
             font-weight: bold;
             color: #666;
         }
         
         @keyframes pulse {
             0% { opacity: 1; transform: scale(1); }
             50% { opacity: 0.7; transform: scale(1.1); }
             100% { opacity: 1; transform: scale(1); }
         }
         
         /* Hover effects for cells */
         .cell:hover {
             transform: scale(1.2);
             z-index: 10;
         }
         
         .driver:hover, .rider:hover, .pickup:hover, .dropoff:hover, .pending:hover {
             transform: scale(1.3);
             z-index: 10;
         }
     </style>
</head>
<body>
    <div class="container">
        <h1>Ride Dispatch System</h1>
        
                 <div class="legend">
             <h3>Legend:</h3>
             <div class="legend-item">
                 <span class="legend-color" style="background-color: #27ae60; border: 1px solid #229954;"></span>
                 Driver
             </div>
             <div class="legend-item">
                 <span class="legend-color" style="background-color: #3498db; border: 1px solid #2980b9;"></span>
                 Rider
             </div>
             <div class="legend-item">
                 <span class="legend-color" style="background-color: #e67e22; border: 1px solid #d35400;"></span>
                 Pickup
             </div>
             <div class="legend-item">
                 <span class="legend-color" style="background-color: #9b59b6; border: 1px solid #8e44ad;"></span>
                 Dropoff
             </div>
             <div class="legend-item">
                 <span class="legend-color" style="background-color: #f39c12; border: 1px solid #e67e22; animation: pulse 2s infinite;"></span>
                 Pending Acceptance
             </div>
         </div>

        <div class="grid-container">
            <div class="grid" id="grid"></div>
        </div>

        <div class="controls">
            <h3>Controls</h3>
            
            <div class="control-group">
                <label>Add Driver:</label>
                <input type="number" id="driverX" placeholder="X" min="0" max="99" value="50">
                <input type="number" id="driverY" placeholder="Y" min="0" max="99" value="50">
                <button onclick="addDriver()">Add Driver</button>
            </div>

            <div class="control-group">
                <label>Add Rider:</label>
                <input type="number" id="pickupX" placeholder="Pickup X" min="0" max="99" value="20">
                <input type="number" id="pickupY" placeholder="Pickup Y" min="0" max="99" value="20">
                <input type="number" id="dropoffX" placeholder="Dropoff X" min="0" max="99" value="80">
                <input type="number" id="dropoffY" placeholder="Dropoff Y" min="0" max="99" value="80">
                <button onclick="addRider()">Add Rider</button>
            </div>

            <div class="control-group">
                <label>Request Ride:</label>
                <select id="riderSelect">
                    <option value="">Select a rider...</option>
                </select>
                <button onclick="requestRide()">Request Ride</button>
            </div>

            <div class="control-group">
                <button onclick="nextTick()">Next Tick</button>
                <button onclick="refreshState()">Refresh State</button>
                <button onclick="clearState()" style="background-color: #f44336;">Clear All State</button>
            </div>
        </div>

        <div class="status">
            <h3>System Status</h3>
            <p><strong>Current Tick:</strong> <span id="currentTick">0</span></p>
            <p><strong>Drivers:</strong> <span id="driverCount">0</span></p>
            <p><strong>Riders:</strong> <span id="riderCount">0</span></p>
            <p><strong>Active Rides:</strong> <span id="rideCount">0</span></p>
        </div>

        <div class="ride-list">
            <h3>Ride Requests</h3>
            <div id="rideList"></div>
        </div>

        <div class="log-section">
            <h3>Ride Request Log</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry">System initialized. Ready to process ride requests.</div>
            </div>
        </div>
    </div>

    <script>
                 let state = {
             tick: 0,
             drivers: [],
             riders: [],
             rides: [],
             grid_size: 20
         };

         // Log management
         function addLogEntry(message, type = 'info') {
             const logContainer = document.getElementById('logContainer');
             const logEntry = document.createElement('div');
             logEntry.className = `log-entry ${type}`;
             
             const timestamp = new Date().toLocaleTimeString();
             logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
             
             logContainer.appendChild(logEntry);
             
             // Auto-scroll to bottom
             logContainer.scrollTop = logContainer.scrollHeight;
             
             // Keep only last 100 entries to prevent memory issues
             const entries = logContainer.querySelectorAll('.log-entry');
             if (entries.length > 100) {
                 entries[0].remove();
             }
         }

        // Initialize grid
        function initializeGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            for (let y = 0; y < 100; y++) {
                for (let x = 0; x < 100; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `cell-${x}-${y}`;
                    grid.appendChild(cell);
                }
            }
        }

        // Update grid display
        function updateGrid() {
            // Clear grid
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.className = 'cell';
            });

            // Draw drivers
            state.drivers.forEach(driver => {
                const cell = document.getElementById(`cell-${driver.location.x}-${driver.location.y}`);
                if (cell) {
                    cell.classList.add('driver');
                }
            });

            // Draw riders (only show waiting riders at their pickup location)
            state.riders.forEach(rider => {
                if (rider.status === 'waiting') {
                    const cell = document.getElementById(`cell-${rider.pickup_location.x}-${rider.pickup_location.y}`);
                    if (cell) {
                        cell.classList.add('rider');
                    }
                }
            });

            // Draw active rides
            state.rides.forEach(ride => {
                if (ride.status === 'accepted' || ride.status === 'pending') {
                    // Find the assigned driver to check their status
                    let driverStatus = null;
                    if (ride.assigned_driver_id) {
                        const driver = state.drivers.find(d => d.id === ride.assigned_driver_id);
                        if (driver) {
                            driverStatus = driver.status;
                        }
                    }
                    
                    // Show pickup location only if driver hasn't reached it yet
                    // (when ride is pending OR when driver is still going to pickup)
                    if (ride.status === 'pending' || 
                        (ride.status === 'accepted' && driverStatus === 'going_to_pickup')) {
                        const pickupCell = document.getElementById(`cell-${ride.pickup_location.x}-${ride.pickup_location.y}`);
                        if (pickupCell) {
                            pickupCell.classList.add('pickup');
                        }
                    }
                    
                    // Show dropoff location only if driver hasn't reached it yet
                    // (when ride is pending OR when driver is going to pickup OR when driver is driving to destination)
                    if (ride.status === 'pending' || 
                        (ride.status === 'accepted' && (driverStatus === 'going_to_pickup' || driverStatus === 'driving_to_dest'))) {
                        const dropoffCell = document.getElementById(`cell-${ride.dropoff_location.x}-${ride.dropoff_location.y}`);
                        if (dropoffCell) {
                            dropoffCell.classList.add('dropoff');
                        }
                    }
                    
                    // Add pending indicator for rides waiting for driver acceptance
                    if (ride.status === 'pending') {
                        const pickupCell = document.getElementById(`cell-${ride.pickup_location.x}-${ride.pickup_location.y}`);
                        if (pickupCell) {
                            pickupCell.classList.add('pending');
                        }
                    }
                }
            });
        }

        // Update status display
        function updateStatus() {
            document.getElementById('currentTick').textContent = state.tick;
            document.getElementById('driverCount').textContent = state.drivers.length;
            document.getElementById('riderCount').textContent = state.riders.length;
            document.getElementById('rideCount').textContent = state.rides.filter(r => r.status === 'accepted' || r.status === 'pending').length;
        }

        // Update rider select dropdown
        function updateRiderSelect() {
            const select = document.getElementById('riderSelect');
            select.innerHTML = '<option value="">Select a rider...</option>';
            
            // Only show riders with WAITING status (available for ride requests)
            state.riders.forEach(rider => {
                if (rider.status === 'waiting') {
                    const option = document.createElement('option');
                    option.value = rider.id;
                    option.textContent = `Rider ${rider.id.slice(0, 8)} (${rider.pickup_location.x},${rider.pickup_location.y}) → (${rider.dropoff_location.x},${rider.dropoff_location.y})`;
                    select.appendChild(option);
                }
            });
        }

        // Update ride list
        function updateRideList() {
            const rideList = document.getElementById('rideList');
            rideList.innerHTML = '';
            
            state.rides.forEach(ride => {
                const rideItem = document.createElement('div');
                rideItem.className = 'ride-item';
                
                // Get driver info if assigned
                let driverInfo = 'No driver assigned';
                if (ride.assigned_driver_id) {
                    const driver = state.drivers.find(d => d.id === ride.assigned_driver_id);
                    if (driver) {
                        driverInfo = `Driver: ${driver.id.slice(0, 8)} (${driver.location.x},${driver.location.y}) - ${driver.status}`;
                    } else {
                        driverInfo = `Driver: ${ride.assigned_driver_id.slice(0, 8)}`;
                    }
                }
                
                rideItem.innerHTML = `
                    <strong>Ride ${ride.id.slice(0, 8)}</strong><br>
                    Status: ${ride.status}<br>
                    Pickup: (${ride.pickup_location.x}, ${ride.pickup_location.y})<br>
                    Dropoff: (${ride.dropoff_location.x}, ${ride.dropoff_location.y})<br>
                    ${driverInfo}
                    ${ride.status === 'pending' ? `
                        <br><button onclick="acceptRide('${ride.id}')" style="background-color: #4CAF50;">Accept Ride</button>
                        <button onclick="rejectRide('${ride.id}')" style="background-color: #f44336;">Reject Ride</button>
                    ` : ''}
                `;
                rideList.appendChild(rideItem);
            });
        }

        // API functions
        async function fetchState() {
            try {
                const response = await fetch('/state');
                state = await response.json();
                updateGrid();
                updateStatus();
                updateRiderSelect();
                updateRideList();
            } catch (error) {
                console.error('Error fetching state:', error);
            }
        }

                 async function addDriver() {
             const x = parseInt(document.getElementById('driverX').value);
             const y = parseInt(document.getElementById('driverY').value);
             
             try {
                 const response = await fetch('/drivers', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({ x, y })
                 });
                 
                 if (response.ok) {
                     await fetchState();
                     addLogEntry(`Driver added at location (${x}, ${y})`, 'info');
                 } else {
                     const errorText = await response.text();
                     console.error('Server error:', errorText);
                     addLogEntry(`Failed to add driver at (${x}, ${y}): ${errorText}`, 'warning');
                     alert('Failed to add driver: ' + errorText);
                 }
             } catch (error) {
                 console.error('Error adding driver:', error);
                 addLogEntry(`Error adding driver at (${x}, ${y}): ${error.message}`, 'warning');
                 alert('Error adding driver: ' + error.message);
             }
         }

                 async function addRider() {
             const pickupX = parseInt(document.getElementById('pickupX').value);
             const pickupY = parseInt(document.getElementById('pickupY').value);
             const dropoffX = parseInt(document.getElementById('dropoffX').value);
             const dropoffY = parseInt(document.getElementById('dropoffY').value);
             
             try {
                 const response = await fetch('/riders', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         pickup_location: { x: pickupX, y: pickupY },
                         dropoff_location: { x: dropoffX, y: dropoffY }
                     })
                 });
                 
                 if (response.ok) {
                     await fetchState();
                     addLogEntry(`Rider added. Pickup: (${pickupX}, ${pickupY}) → Dropoff: (${dropoffX}, ${dropoffY})`, 'info');
                 } else {
                     addLogEntry(`Failed to add rider from (${pickupX}, ${pickupY}) to (${dropoffX}, ${dropoffY})`, 'warning');
                     alert('Failed to add rider');
                 }
             } catch (error) {
                 console.error('Error adding rider:', error);
                 addLogEntry(`Error adding rider: ${error.message}`, 'warning');
                 alert('Error adding rider');
             }
         }

                 async function requestRide() {
             const riderId = document.getElementById('riderSelect').value;
             if (!riderId) {
                 alert('Please select a rider');
                 return;
             }
             
             try {
                 const response = await fetch('/rides', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({ rider_id: riderId })
                 });
                 
                 if (response.ok) {
                     await fetchState();
                     
                     // Find rider details for logging
                     const rider = state.riders.find(r => r.id === riderId);
                     if (rider) {
                         addLogEntry(`Ride REQUESTED for Rider ${riderId.slice(0, 8)}. Pickup: (${rider.pickup_location.x},${rider.pickup_location.y}) → Dropoff: (${rider.dropoff_location.x},${rider.dropoff_location.y})`, 'info');
                     } else {
                         addLogEntry(`Ride REQUESTED for Rider ${riderId.slice(0, 8)}`, 'info');
                     }
                 } else {
                     addLogEntry(`Failed to request ride for Rider ${riderId.slice(0, 8)}`, 'warning');
                     alert('Failed to request ride');
                 }
             } catch (error) {
                 console.error('Error requesting ride:', error);
                 addLogEntry(`Error requesting ride for Rider ${riderId.slice(0, 8)}: ${error.message}`, 'warning');
                 alert('Error requesting ride');
             }
         }

        async function nextTick() {
            try {
                const response = await fetch('/tick', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await fetchState();
                } else {
                    alert('Failed to advance time');
                }
            } catch (error) {
                console.error('Error advancing time:', error);
                alert('Error advancing time');
            }
        }

                 async function acceptRide(rideId) {
             try {
                 const response = await fetch(`/rides/${rideId}/respond`, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({ action: 'accept', ride_id: rideId })
                 });
                 
                 if (response.ok) {
                     await fetchState();
                     
                     // Find ride details for logging
                     const ride = state.rides.find(r => r.id === rideId);
                     const driver = state.drivers.find(d => d.id === ride?.assigned_driver_id);
                     
                     if (ride && driver) {
                         addLogEntry(`Ride ${rideId.slice(0, 8)} ACCEPTED by Driver ${driver.id.slice(0, 8)}. Pickup: (${ride.pickup_location.x},${ride.pickup_location.y}) → Dropoff: (${ride.dropoff_location.x},${ride.dropoff_location.y})`, 'accepted');
                     } else {
                         addLogEntry(`Ride ${rideId.slice(0, 8)} ACCEPTED`, 'accepted');
                     }
                     
                     alert('Ride accepted successfully!');
                 } else {
                     const errorText = await response.text();
                     addLogEntry(`Failed to accept ride ${rideId.slice(0, 8)}: ${errorText}`, 'warning');
                     alert('Failed to accept ride: ' + errorText);
                 }
             } catch (error) {
                 console.error('Error accepting ride:', error);
                 addLogEntry(`Error accepting ride ${rideId.slice(0, 8)}: ${error.message}`, 'warning');
                 alert('Error accepting ride: ' + error.message);
             }
         }

                 async function rejectRide(rideId) {
             try {
                 const response = await fetch(`/rides/${rideId}/respond`, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({ action: 'reject', ride_id: rideId })
                 });
                 
                 if (response.ok) {
                     await fetchState();
                     
                     // Find ride details for logging
                     const ride = state.rides.find(r => r.id === rideId);
                     const driver = state.drivers.find(d => d.id === ride?.assigned_driver_id);
                     
                     if (ride && driver) {
                         addLogEntry(`Ride ${rideId.slice(0, 8)} REJECTED by Driver ${driver.id.slice(0, 8)}. Pickup: (${ride.pickup_location.x},${ride.pickup_location.y}) → Dropoff: (${ride.dropoff_location.x},${ride.dropoff_location.y})`, 'rejected');
                     } else {
                         addLogEntry(`Ride ${rideId.slice(0, 8)} REJECTED`, 'rejected');
                     }
                     
                     alert('Ride rejected successfully!');
                 } else {
                     const errorText = await response.text();
                     addLogEntry(`Failed to reject ride ${rideId.slice(0, 8)}: ${errorText}`, 'warning');
                     alert('Failed to reject ride: ' + errorText);
                 }
             } catch (error) {
                 console.error('Error rejecting ride:', error);
                 addLogEntry(`Error rejecting ride ${rideId.slice(0, 8)}: ${error.message}`, 'warning');
                 alert('Error rejecting ride: ' + error.message);
             }
         }

        async function refreshState() {
            await fetchState();
        }

                 async function clearState() {
             if (!confirm('Are you sure you want to clear all system state? This will remove all drivers, riders, and ride requests.')) {
                 return;
             }
             
             try {
                 const response = await fetch('/clear-state', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     }
                 });
                 
                 if (response.ok) {
                     const result = await response.json();
                     await fetchState();
                     addLogEntry('System state cleared successfully. All drivers, riders, and ride requests removed.', 'info');
                     alert('System state cleared successfully!');
                 } else {
                     const errorText = await response.text();
                     addLogEntry(`Failed to clear state: ${errorText}`, 'warning');
                     alert('Failed to clear state: ' + errorText);
                 }
             } catch (error) {
                 console.error('Error clearing state:', error);
                 addLogEntry(`Error clearing state: ${error.message}`, 'warning');
                 alert('Error clearing state: ' + error.message);
             }
         }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeGrid();
            fetchState();
        });
    </script>
</body>
</html> 